<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Ad Block Detector</title>
    <style>
        #detection-root {
            position: absolute;
            left: -9999px;
            height: 1px;
            width: 1px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <h1>Ad Block Detection Test</h1>
    <div id="status">Initializing checks...</div>

    <div id="detection-root" data-test="ad-detection"></div>

    <script>
        (async function() {
            // Configuration - MUST create this file on your server
            const TEST_FILE = '/detection-file.js';
            const CONTROL_FILE = '/control-file.js';

            async function serverCheck(url) {
                try {
                    const response = await fetch(url, {method: 'HEAD'});
                    return response.ok;
                } catch {
                    return false;
                }
            }

            async function runDetection() {
                // Step 1: Verify server configuration
                const [testFileExists, controlFileExists] = await Promise.all([
                    serverCheck(TEST_FILE),
                    serverCheck(CONTROL_FILE)
                ]);

                if (!testFileExists || !controlFileExists) {
                    throw new Error('Server configuration error');
                }

                // Step 2: Concurrent resource checks
                const [testResponse, controlResponse] = await Promise.all([
                    fetch(TEST_FILE).catch(() => ({ok: false})),
                    fetch(CONTROL_FILE).catch(() => ({ok: false}))
                ]);

                // Step 3: Element visibility check
                const testElement = document.getElementById('detection-root');
                const elementVisible = testElement && 
                    testElement.offsetHeight > 0 &&
                    window.getComputedStyle(testElement).display !== 'none';

                // Step 4: Analysis
                return {
                    testBlocked: !testResponse.ok,
                    controlBlocked: !controlResponse.ok,
                    elementHidden: !elementVisible
                };
            }

            async function showResults() {
                const status = document.getElementById('status');
                
                try {
                    const {testBlocked, controlBlocked, elementHidden} = await runDetection();
                    
                    if (controlBlocked) {
                        status.textContent = 'Network error detected';
                        status.style.color = '#f39c12';
                    } else if (testBlocked || elementHidden) {
                        status.textContent = 'Ad blocking detected';
                        status.style.color = '#e74c3c';
                    } else {
                        status.textContent = 'No ad blocking detected';
                        status.style.color = '#2ecc71';
                    }
                } catch (error) {
                    status.textContent = error.message;
                    status.style.color = '#e67e22';
                }

                status.style.fontWeight = 'bold';
                status.style.padding = '15px';
                status.style.marginTop = '20px';
            }

            // Start detection with delay
            setTimeout(showResults, 1000);
        })();
    </script>
</body>
</html>
