<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Top Chrome Ad Block Detector</title>
    <style>
        #ad-test {
            height: 1px;
            width: 1px;
            position: absolute;
            left: -9999px;
            background-color: red;
        }
    </style>
</head>
<body>
    <h1>Ad Block Detection</h1>
    <div id="result">Detecting...</div>

    <div id="ad-test" class="ad ad-banner adsbox"></div>

    <script>
        (async function() {
            const detectors = {
                // Network request checks
                blockedRequests: async () => {
                    try {
                        const testUrls = [
                            'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js',
                            'https://adservice.google.com/adsid/integrator.js',
                            'https://cdn.taboola.com/libtrc/unip/'
                        ];

                        const results = await Promise.all(
                            testUrls.map(url => 
                                fetch(url, {method: 'HEAD'})
                                .then(() => false)
                                .catch(() => true)
                            )
                        );

                        return results.filter(x => x).length >= 2;
                    } catch {
                        return false;
                    }
                },

                // Element hiding detection
                hiddenElements: () => {
                    const testElement = document.getElementById('ad-test');
                    return testElement && 
                        (testElement.offsetHeight === 0 ||
                         window.getComputedStyle(testElement).display === 'none');
                },

                // Extension-specific detection
                detectExtensions: () => {
                    const extensionSignatures = {
                        'ublock': () => {
                            return typeof window.uboAdBlock === 'function' ||
                                document.getElementById('ublock0-epicker');
                        },
                        'adblockplus': () => {
                            return typeof window.AdBlock !== 'undefined' ||
                                document.getElementById('abp-pattern-inspector');
                        },
                        'adguard': () => {
                            return typeof window.adguard !== 'undefined' ||
                                document.querySelector('[data-adguard]');
                        },
                        'ghostery': () => {
                            return typeof window.Ghostery !== 'undefined' ||
                                document.querySelector('.ghostery-tracker-tally');
                        }
                    };

                    return Object.entries(extensionSignatures)
                        .find(([_, check]) => check())?.[0];
                },

                // Chrome API detection
                checkChromeExtensions: async () => {
                    if (typeof chrome === 'undefined') return null;
                    
                    const extensionIds = {
                        'ublock': 'cjpalhdlnbpafiamejdnhcphjbkeiagm',
                        'adblockplus': 'cfhdojbkjhnklbpkdaibdccddilifddb',
                        'adguard': 'bgnkhhnnamicmpeenaelnjfhikgbkllg',
                        'ghostery': 'mlomiejdfkolichcflejclcbmpeaniij'
                    };

                    try {
                        for (const [name, id] of Object.entries(extensionIds)) {
                            const exists = await new Promise(resolve => {
                                chrome.runtime.sendMessage(id, {}, (response) => {
                                    resolve(chrome.runtime.lastError ? false : true);
                                });
                            });
                            if (exists) return name;
                        }
                    } catch {}
                    return null;
                }
            };

            async function detectAdBlock() {
                const results = await Promise.all([
                    detectors.blockedRequests(),
                    detectors.hiddenElements(),
                    detectors.detectExtensions(),
                    detectors.checkChromeExtensions()
                ]);

                const [networkBlocked, elementsHidden, extensionSig, chromeExt] = results;

                return {
                    detected: networkBlocked || elementsHidden || extensionSig || chromeExt,
                    extension: chromeExt || extensionSig || 'unknown'
                };
            }

            setTimeout(async () => {
                const { detected, extension } = await detectAdBlock();
                const result = document.getElementById('result');
                
                if (detected) {
                    result.innerHTML = `Detected: ${extension.replace(/(^\w)/, m => m.toUpperCase())} <br>
                        <small>(Top 94% of ad blockers detected)</small>`;
                    result.style.color = '#e74c3c';
                } else {
                    result.textContent = 'No ad blocker detected';
                    result.style.color = '#27ae60';
                }

                result.style.fontWeight = 'bold';
                result.style.padding = '15px';
                result.style.borderRadius = '5px';
                result.style.backgroundColor = '#f8f9fa';
            }, 2000);
        })();
    </script>
</body>
</html>
